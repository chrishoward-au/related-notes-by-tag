/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
If you want to view the source, please visit the github repository of this plugin
*/

var D=Object.defineProperty;var C=Object.getOwnPropertyDescriptor;var y=Object.getOwnPropertyNames;var x=Object.prototype.hasOwnProperty;var F=(r,e)=>{for(var i in e)D(r,i,{get:e[i],enumerable:!0})},k=(r,e,i,t)=>{if(e&&typeof e=="object"||typeof e=="function")for(let a of y(e))!x.call(r,a)&&a!==i&&D(r,a,{get:()=>e[a],enumerable:!(t=C(e,a))||t.enumerable});return r};var H=r=>k(D({},"__esModule",{value:!0}),r);var b={};F(b,{default:()=>A});module.exports=H(b);var u=require("obsidian");var c=require("obsidian"),I={customSidebarTitle:"Related Notes",defaultSortMode:"name",defaultFilterMode:1,excludedTags:"",defaultGroupState:"collapsed"},v=class extends c.PluginSettingTab{constructor(e,i){super(e,i),this.plugin=i}display(){let{containerEl:e}=this;e.empty(),e.createEl("h2",{text:"Related notes by tag"}),new c.Setting(e).setName("Custom sidebar title").setDesc("Title displayed at the top of the Related Notes sidebar").addText(t=>t.setPlaceholder("Enter custom title").setValue(this.plugin.settings.customSidebarTitle).onChange(async a=>{this.plugin.settings.customSidebarTitle=a,await this.plugin.saveSettings()})),new c.Setting(e).setName("Default sort mode").setDesc("How to sort related notes by default").addDropdown(t=>t.addOption("name","Name").addOption("date","Date Edited").addOption("created","Date Created").setValue(this.plugin.settings.defaultSortMode).onChange(async a=>{this.plugin.settings.defaultSortMode=a,await this.plugin.saveSettings()})),new c.Setting(e).setName("Excluded tags").setDesc("Comma-separated list of tags to exclude from related notes").addText(t=>t.setPlaceholder("e.g., #ignore, #draft").setValue(this.plugin.settings.excludedTags).onChange(async a=>{this.plugin.settings.excludedTags=a,await this.plugin.saveSettings()})),new c.Setting(e).setName("Default group state").setDesc("Initial expansion state of tag groups").addDropdown(t=>t.addOption("collapsed","Collapsed").addOption("expanded","Expanded").setValue(this.plugin.settings.defaultGroupState).onChange(async a=>{this.plugin.settings.defaultGroupState=a,await this.plugin.saveSettings()})),e.createEl("h3",{text:"Activation and Usage Instructions"});let i=e.createDiv("related-notes-instructions");i.createEl("p",{text:"To activate the Related Notes sidebar:"}),i.createEl("ul",{},t=>{t.createEl("li",{text:"Click the ribbon icon (tag icon)"}),t.createEl("li",{text:'Or use the command palette: "Open Related Notes Panel"'})}),i.createEl("p",{text:"Usage:"}),i.createEl("ul",{},t=>{t.createEl("li",{text:"Click tag group header to expand/collapse group"}),t.createEl("li",{text:"Click note name to open in current tab"}),t.createEl("li",{text:"cmd/ctrl click note name to open in new tab"}),t.createEl("li",{text:"Click Name/Date to change sort order"})})}};var M=require("obsidian");var P=require("obsidian"),m=class{constructor(e){this.app=e}analyzeRelatedNotes(e,i){let t=this.app.metadataCache.getFileCache(e);if(!t)return{relatedNotesMap:new Map,currentNoteTags:[]};let a=(0,P.getAllTags)(t);if(!a||a.length===0)return{relatedNotesMap:new Map,currentNoteTags:[]};let s=this.getFilteredTags(a,i.excludedTags);return{relatedNotesMap:this.findRelatedNotes(e,s,i.defaultFilterMode),currentNoteTags:s}}getFilteredTags(e,i){let t=i.split(",").map(a=>a.trim().toLowerCase()).filter(a=>a.length>0);return[...new Set(e)].filter(a=>!t.includes(a.toLowerCase()))}findRelatedNotes(e,i,t){let a=new Map,s=this.app.vault.getMarkdownFiles();for(let o of s){if(o.path===e.path)continue;let p=this.getOverlappingTags(o,i);p.length>=t&&p.forEach(E=>{var _;a.has(E)||a.set(E,[]),(_=a.get(E))==null||_.push(o)})}return a}getOverlappingTags(e,i){let t=this.app.metadataCache.getFileCache(e);if(!t)return[];let a=(0,P.getAllTags)(t);if(!a)return[];let s=[...new Set(a)];return i.filter(o=>s.includes(o))}sortFiles(e,i){let t=[...e];switch(i){case"date":return t.sort((a,s)=>s.stat.mtime-a.stat.mtime);case"created":return t.sort((a,s)=>s.stat.ctime-a.stat.ctime);default:return t.sort((a,s)=>a.basename.localeCompare(s.basename))}}};var N=require("obsidian");var g={SORT:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M3 6h18M6 12h12M10 18h4"/></svg>',FILTER:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><path d="M22 3H2l8 9.46V19l4 2v-8.54L22 3z"/></svg>',RELATED_NOTES:'<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tags"><path d="M9 5H2v7l6.29 6.29c.94.94 2.48.94 3.42 0l3.58-3.58c.94-.94.94-2.48 0-3.42L9 5Z"/><path d="M6 9.01V9"/><path d="m15 5 6.3 6.3a2.69 2.69 0 0 1 0 3.79L17.5 19a2.69 2.69 0 0 1-3.79 0L10 15.21"/></svg>'},n={CONTAINER:"related-notes-container",HEADER:"related-notes-header",TITLE:"related-notes-title",ACTION_BUTTONS:"action-buttons",SORT_CONTROLS:"sort-controls",FILTER_CONTROLS:"filter-controls",DROPDOWN_CONTAINER:"dropdown-container",DROPDOWN_TRIGGER:"dropdown-trigger",DROPDOWN_MENU:"dropdown-menu",DROPDOWN_ITEM:"dropdown-item",DROPDOWN_ITEM_ACTIVE:"is-active",DROPDOWN_VISIBLE:"is-visible",ACTIVE_FILE_NAME:"related-activefile-name",TAG_GROUP:"related-notes-tag-group",TAG_GROUP_HEADER:"related-notes-tag-group-header",NOTES_LIST:"related-notes-list",LIST_ITEM:"related-notes-list-item",NOTE_LINK:"related-note-link",SEPARATOR:"related-notes-separator",PREVIEW:"related-notes-preview",PREVIEW_LOADED:"is-loaded",INSTRUCTIONS:"related-notes-instructions"},w={VIEW_UPDATE_DELAY:50,PREVIEW_RENDER_DELAY:150},T={PREVIEW_POPUP_WIDTH:400,PREVIEW_POPUP_MARGIN:10,PREVIEW_MAX_HEIGHT:"40vh"},l={NAME:"name",DATE:"date",CREATED:"created"},d={ONE_TAG:1,TWO_TAGS:2,THREE_TAGS:3};var f={[l.NAME]:"Name",[l.DATE]:"Modified Date",[l.CREATED]:"Created Date"},R={[d.ONE_TAG]:"Match at least 1 tag",[d.TWO_TAGS]:"Match at least 2 tags",[d.THREE_TAGS]:"Match at least 3 tags"};var S=class{constructor(e){this.app=e;this.previewPopup=null;this.currentPreviewFile=null;this.isModifierHeld=!1;this.lastMousePosition={x:0,y:0};this.trackMousePosition=e=>{this.lastMousePosition={x:e.clientX,y:e.clientY}};this.handleKeyDown=e=>{if(this.isModifierHeld=e.metaKey||e.ctrlKey,this.isModifierHeld){let i=document.elementFromPoint(this.lastMousePosition.x,this.lastMousePosition.y),t=i==null?void 0:i.closest(`.${n.NOTE_LINK}`);if(t instanceof HTMLElement&&t.dataset.filePath){let a=this.app.vault.getAbstractFileByPath(t.dataset.filePath);a instanceof N.TFile&&this.showPreview(a,t)}}};this.handleKeyUp=e=>{this.isModifierHeld=e.metaKey||e.ctrlKey,!this.isModifierHeld&&this.previewPopup&&this.hidePreview()};this.hidePreviewOnClick=()=>{this.hidePreview()};this.setupEventListeners()}setupEventListeners(){document.addEventListener("mousemove",this.trackMousePosition),document.addEventListener("keydown",this.handleKeyDown),document.addEventListener("keyup",this.handleKeyUp)}cleanup(){document.removeEventListener("mousemove",this.trackMousePosition),document.removeEventListener("keydown",this.handleKeyDown),document.removeEventListener("keyup",this.handleKeyUp),this.hidePreview()}showPreview(e,i){this.hidePreview(),this.previewPopup=document.body.createDiv(n.PREVIEW),this.currentPreviewFile=e;let t=this.calculatePosition(i);this.applyPopupStyles(t),document.addEventListener("click",this.hidePreviewOnClick,{once:!0}),this.renderPreviewContent(e,i)}calculatePosition(e){let i=e.getBoundingClientRect(),t=window.innerWidth,a=T.PREVIEW_POPUP_WIDTH,s=T.PREVIEW_POPUP_MARGIN,o;return i.right+a+s<=t?o=i.right+s:i.left-a-s>=0?o=i.left-a-s:o=Math.max(s,Math.min((t-a)/2,t-a-s)),{left:o,top:i.top}}applyPopupStyles(e){this.previewPopup&&Object.assign(this.previewPopup.style,{position:"fixed",left:`${e.left}px`,top:`${e.top}px`,zIndex:"9999",width:`${T.PREVIEW_POPUP_WIDTH}px`,maxHeight:T.PREVIEW_MAX_HEIGHT,overflowY:"auto"})}renderPreviewContent(e,i){setTimeout(()=>{this.previewPopup&&this.currentPreviewFile===e&&this.isModifierHeld&&N.MarkdownRenderer.render(this.app,`![[${e.basename}]]`,this.previewPopup,e.path,this).then(()=>{var t;(t=this.previewPopup)==null||t.addClass(n.PREVIEW_LOADED),!i.matches(":hover")||this.isModifierHeld})},w.PREVIEW_RENDER_DELAY)}hidePreview(){this.previewPopup&&(this.previewPopup.remove(),this.previewPopup=null,this.currentPreviewFile=null)}getIsModifierHeld(){return this.isModifierHeld}};var O=class{createDropdown(e,i){let t=e.createDiv(n.DROPDOWN_CONTAINER);i.containerClass&&t.addClass(i.containerClass);let a=t.createEl("button",{cls:n.DROPDOWN_TRIGGER});a.innerHTML=i.icon;let s=t.createDiv(n.DROPDOWN_MENU);return i.options.forEach(o=>{let p=s.createEl("div",{cls:`${n.DROPDOWN_ITEM} ${o.isActive?n.DROPDOWN_ITEM_ACTIVE:""}`,text:o.label});p.addEventListener("click",()=>{i.onItemClick(o.value),s.classList.remove(n.DROPDOWN_VISIBLE),s.querySelectorAll(`.${n.DROPDOWN_ITEM}`).forEach(E=>E.classList.remove(n.DROPDOWN_ITEM_ACTIVE)),p.classList.add(n.DROPDOWN_ITEM_ACTIVE)})}),a.addEventListener("click",o=>{o.stopPropagation(),s.classList.toggle(n.DROPDOWN_VISIBLE)}),t}createSortDropdown(e,i,t){let a=[{value:l.NAME,label:f[l.NAME],isActive:i===l.NAME},{value:l.DATE,label:f[l.DATE],isActive:i===l.DATE},{value:l.CREATED,label:f[l.CREATED],isActive:i===l.CREATED}];return this.createDropdown(e,{icon:g.SORT,options:a,onItemClick:s=>t(s),containerClass:n.SORT_CONTROLS})}createFilterDropdown(e,i,t){let a=[{value:d.ONE_TAG,label:R[d.ONE_TAG],isActive:i===d.ONE_TAG},{value:d.TWO_TAGS,label:R[d.TWO_TAGS],isActive:i===d.TWO_TAGS},{value:d.THREE_TAGS,label:R[d.THREE_TAGS],isActive:i===d.THREE_TAGS}];return this.createDropdown(e,{icon:g.FILTER,options:a,onItemClick:s=>t(s),containerClass:n.FILTER_CONTROLS})}createHeader(e,i){let t=e.createDiv(n.HEADER);return t.createEl("h4",{text:i,cls:n.TITLE}),t}createActionButtonsContainer(e){return e.createDiv(n.ACTION_BUTTONS)}};var h="related-notes-view",L=class extends M.ItemView{async handleSortChange(e){this.plugin.settings.defaultSortMode=e,await this.plugin.saveSettings(),this.updateView()}async handleFilterChange(e){this.plugin.settings.defaultFilterMode=e,await this.plugin.saveSettings(),this.updateView()}constructor(e,i){super(e),this.plugin=i,this.tagAnalyzer=new m(this.app),this.previewManager=new S(this.app),this.uiRenderer=new O}getViewType(){return h}getDisplayText(){return"Related Notes"}getIcon(){return"tag"}async onOpen(){this.container=this.contentEl,this.container.empty(),this.container.addClass(n.CONTAINER),this.updateView()}async onClose(){this.previewManager.cleanup(),this.container.empty()}async updateView(){if(!this.plugin.app.workspace.layoutReady)return;this.container.empty(),this.container.addClass(n.CONTAINER);let e=this.renderHeader();this.renderControls(e);let i=this.getActiveFile();if(!i)return;let t=this.tagAnalyzer.analyzeRelatedNotes(i,this.plugin.settings);if(t.currentNoteTags.length===0){this.container.createEl("p",{text:"Active note has no tags."});return}if(t.relatedNotesMap.size===0){this.container.createEl("p",{text:"No other notes found with matching tags."});return}this.renderTagGroups(t.relatedNotesMap)}renderHeader(){return this.uiRenderer.createHeader(this.container,this.plugin.settings.customSidebarTitle||"Related Notes")}renderControls(e){let i=this.uiRenderer.createActionButtonsContainer(e);this.uiRenderer.createSortDropdown(i,this.plugin.settings.defaultSortMode,t=>this.handleSortChange(t)),this.uiRenderer.createFilterDropdown(i,this.plugin.settings.defaultFilterMode,t=>this.handleFilterChange(t))}getActiveFile(){let e=this.app.workspace.getActiveFile();return!e||!(e instanceof M.TFile)?(this.container.createEl("p",{text:"No active note or not a markdown file."}),null):(this.container.createEl("p",{text:e.basename,cls:n.ACTIVE_FILE_NAME}),e)}renderTagGroups(e){e.forEach((i,t)=>{let a=this.container.createDiv({cls:`${n.TAG_GROUP} ${this.plugin.settings.defaultGroupState}`}),s=a.createEl("div",{text:`Notes with tag: ${t}`,cls:n.TAG_GROUP_HEADER}),o=a.createEl("ul",{cls:n.NOTES_LIST});o.style.display=this.plugin.settings.defaultGroupState==="collapsed"?"none":"",this.setupTagGroupToggle(a,s,o);let p=this.tagAnalyzer.sortFiles(i,this.plugin.settings.defaultSortMode);this.renderFileList(o,p),a.createEl("hr",{cls:n.SEPARATOR})})}setupTagGroupToggle(e,i,t){i.addEventListener("click",()=>{e.toggleClass("collapsed",!e.hasClass("collapsed")),t.style.display=e.hasClass("collapsed")?"none":""})}renderFileList(e,i){i.forEach(t=>{let a=e.createEl("li",{cls:n.LIST_ITEM}),s=this.createFileLink(a,t);this.setupFileLinkEvents(s,t)})}createFileLink(e,i){let t=e.createEl("a",{text:i.basename,href:"#",title:`Hold Cmd/Ctrl + hover to preview
Click to open`,cls:n.NOTE_LINK});return t.dataset.filePath=i.path,t}setupFileLinkEvents(e,i){e.addEventListener("mouseenter",t=>{(t.metaKey||t.ctrlKey||this.previewManager.getIsModifierHeld())&&this.previewManager.showPreview(i,e)}),e.addEventListener("keydown",t=>{(t.metaKey||t.ctrlKey)&&e.matches(":hover")&&this.previewManager.showPreview(i,e)}),e.addEventListener("click",t=>{t.preventDefault(),t.ctrlKey||t.metaKey?this.app.workspace.getLeaf("tab").openFile(i,{active:!0}):this.app.workspace.getLeaf().openFile(i,{active:!0})})}};var A=class extends u.Plugin{constructor(){super(...arguments);this.view=null}async onload(){console.log("Loading Related Notes by Tag plugin"),await this.loadSettings(),this.registerView(h,i=>(this.view=new L(i,this),this.view)),(0,u.addIcon)("related-notes-icon",g.RELATED_NOTES),this.addRibbonIcon("related-notes-icon","Open Related Notes Panel",()=>{this.activateView()}),this.addCommand({id:"open-related-notes-panel",name:"Open Related Notes Panel",callback:()=>{this.activateView()}}),this.addSettingTab(new v(this.app,this)),this.registerEvent(this.app.workspace.on("active-leaf-change",i=>{this.view&&i&&this.view.leaf!==i&&i.view.getViewType()==="markdown"&&setTimeout(async()=>{this.view&&await this.view.updateView()},w.VIEW_UPDATE_DELAY)})),this.registerEvent(this.app.metadataCache.on("changed",async i=>{var t;this.view&&((t=this.app.workspace.getActiveFile())==null?void 0:t.path)===i.path&&await this.view.updateView()})),this.app.workspace.onLayoutReady(()=>{}),console.log("Related Notes by Tag plugin loaded.")}onunload(){console.log("Unloading Related Notes by Tag plugin"),this.app.workspace.detachLeavesOfType(h),this.view=null}async loadSettings(){this.settings=Object.assign({},I,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.view&&await this.view.updateView()}async activateView(){let i=this.app.workspace.getLeavesOfType(h);if(i.length>0){this.app.workspace.revealLeaf(i[0]);return}let t=this.app.workspace.getRightLeaf(!1);t||(t=this.app.workspace.getRightLeaf(!0)),t?(await t.setViewState({type:h,active:!0}),this.app.workspace.revealLeaf(t)):new u.Notice("Could not open Related Notes panel: No available leaf.")}};
